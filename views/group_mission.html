<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Group Mission</title>
    <link rel="stylesheet" href="../styles/manage_mission.css" />
  </head>
  <body>
    <header>
      <div>
        <h1>Manage Group Mission (App)</h1>
      </div>
      <div class="user">
        <h3 id="user-role-display" style="color: #38a169"></h3>
        <button class="sign-out-button" id="sign-out">
          <i class="fas fa-sign-out-alt"></i> Sign Out
        </button>
      </div>
    </header>
    <!-- Loading Overlay
    <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner"></div>
    </div> -->
    <main>
      <section class="navigation">
        <div>
          <img
            src="../denr_logo.png"
            alt="DENR Dagupan Logo"
            height="120px"
            width="120px"
            style="margin: auto"
          />
          <h1 style="font-size: 2rem; text-align: center; font-weight: bold">
            TreeStride
          </h1>
          <a href="dashboard.html" style="font-size: 1rem; padding: 0.6rem"
            ><i class="fas fa-home"></i> Dashboard</a
          >
          <a href="manage_mission.html" style="font-size: 1rem; padding: 0.6rem"
            ><i class="fas fa-tasks"></i> Solo Mission</a
          >
          <a href="group_mission.html" style="font-size: 1rem; padding: 0.6rem"
            ><i class="fas fa-tasks"></i> Group Mission</a
          >
          <a href="announcements.html" style="font-size: 1rem; padding: 0.6rem"
            ><i class="fas fa-bullhorn"></i> Announcements</a
          >
          <a
            href="planting_requests.html"
            style="font-size: 1rem; padding: 0.6rem"
            ><i class="fas fa-seedling"></i> Planting Requests</a
          >
          <a href="tree_inventory.html" style="font-size: 1rem; padding: 0.6rem"
            ><i class="fas fa-hand-paper"></i> Tree Inventory</a
          >
          <a href="manage_trees.html" style="font-size: 1rem; padding: 0.6rem"
            ><i class="fas fa-tree"></i> Manage Trees (App)</a
          >
          <a href="goal_cms.html" style="font-size: 1rem; padding: 0.6rem"
            ><i class="fas fa-shoe-prints"></i>Manage Goals (App)</a
          >
          <a href="reported_posts.html" style="font-size: 1rem; padding: 0.6rem"
            ><i class="fas fa-exclamation-triangle"></i> Reported Posts</a
          >
          <a href="users.html" style="font-size: 1rem; padding: 0.6rem"
            ><i class="fas fa-users-gear"></i> Users (TreeStride)</a
          >
          <a href="staffs.html" style="font-size: 1rem; padding: 0.6rem"
            ><i class="fas fa-user-plus"></i> Manage Staffs</a
          >
        </div>
      </section>
      <section>
        <h2>Create Group Mission</h2>
        <form id="groupMissionForm">
          <label for="goal">Goal (Steps):</label>
          <input type="number" id="goal" name="goal" required />

          <label for="participants">Number of Participants:</label>
          <input type="number" id="participants" name="participants" required />

          <label for="tree">Allocate Tree:</label>
          <select id="tree" name="tree" required>
            <option value="" disabled selected>Select a tree</option>
          </select>

          <button type="submit">Add Group Mission</button>
        </form>
      </section>

      <section>
        <h2>Group Missions</h2>
        <table id="groupMissionsTable">
          <thead>
            <tr>
              <th>Goal (Steps)</th>
              <th>Participants</th>
              <th>Tree</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Group missions will be dynamically loaded here -->
          </tbody>
        </table>
      </section>
    </main>

    <script
      src="https://kit.fontawesome.com/ec19991922.js"
      crossorigin="anonymous"
    ></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getFirestore,
        doc,
        setDoc,
        addDoc,
        collection,
        getDoc,
        query,
        where,
        getDocs,
        updateDoc,
        serverTimestamp,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAUIljfabkgsGO8FkLTfSNMpd7NeZW0a_M",
        authDomain: "treestride-project.firebaseapp.com",
        projectId: "treestride-project",
        storageBucket: "treestride-project.appspot.com",
        messagingSenderId: "218404996569",
        appId: "1:218404996569:web:d1daa406334c19cde5c5c8",
        measurementId: "G-XR01C3LFWD",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      async function loadTreeOptions() {
        const treeRef = collection(db, "tree_inventory");
        const treeSnapshot = await getDocs(treeRef);

        const treeSelect = document.getElementById("tree");

        treeSnapshot.forEach((doc) => {
          const tree = doc.data();
          const option = document.createElement("option");
          option.value = JSON.stringify({
            id: doc.id,
            name: tree.name,
            stocks: tree.stocks,
            image: tree.image, // Add tree image
            type: tree.type, // Add tree type
          });
          option.textContent = `${tree.name} (Stocks: ${tree.stocks}, Type: ${tree.type})`;
          treeSelect.appendChild(option);
        });
      }

      async function loadGroupMissions() {
        const missionsRef = query(
          collection(db, "group_missions"),
          orderBy("timestamp", "desc")
        );
        const missionsSnapshot = await getDocs(missionsRef);

        const tableBody = document.querySelector("#groupMissionsTable tbody");
        tableBody.innerHTML = "";

        missionsSnapshot.forEach((doc) => {
          const mission = doc.data();
          const row = document.createElement("tr");

          row.innerHTML = `
      <td>${mission.goal}</td>
      <td>${mission.participants}</td>
      <td>
        ${mission.treeName} 
        <br><small>(Type: ${mission.treeType})</small>
        ${
          mission.treeImage
            ? `<br><img src="${mission.treeImage}" style="max-width: 100px; max-height: 100px;">`
            : ""
        }
      </td>
      <td>
        <select class="status" data-id="${doc.id}">
          <option value="ongoing" ${
            mission.status === "ongoing" ? "selected" : ""
          }>Ongoing</option>
          <option value="completed" ${
            mission.status === "completed" ? "selected" : ""
          }>Completed</option>
        </select>
      </td>
      <td>
        <button class="save-status" data-id="${doc.id}">Save</button>
      </td>
    `;

          tableBody.appendChild(row);
        });

        document.querySelectorAll(".save-status").forEach((button) => {
          button.addEventListener("click", async (e) => {
            const missionId = e.target.dataset.id;
            const statusSelect = document.querySelector(
              `.status[data-id='${missionId}']`
            );
            const newStatus = statusSelect.value;

            try {
              const missionRef = doc(db, "group_missions", missionId);
              await updateDoc(missionRef, { status: newStatus });
              alert("Status updated successfully.");
            } catch (error) {
              console.error("Error updating status:", error);
              alert("Failed to update status. Please try again.");
            }
          });
        });
      }

      document
        .getElementById("groupMissionForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const goal = parseInt(document.getElementById("goal").value, 10);
          const participants = parseInt(
            document.getElementById("participants").value,
            10
          );
          const treeData = JSON.parse(document.getElementById("tree").value);

          if (participants > treeData.stocks) {
            alert("Not enough stock available for the selected tree.");
            return;
          }

          const groupMission = {
            goal,
            participants,
            participantsJoined: [],
            treeName: treeData.name,
            treeImage: treeData.image,
            treeType: treeData.type,
            status: "ongoing",
            timestamp: serverTimestamp(),
          };

          try {
            // Add group mission to Firestore
            await addDoc(collection(db, "group_missions"), groupMission);

            // Deduct tree stock
            const treeRef = doc(db, "tree_inventory", treeData.id);
            await updateDoc(treeRef, {
              stocks: treeData.stocks - participants,
            });

            // Log the stock deduction in stock_entries
            await addDoc(collection(db, "stock_entries"), {
              treeId: treeData.id,
              treeName: treeData.name,
              treeImage: treeData.image,
              treeType: treeData.type,
              quantity: participants,
              operation: "allotted",
              notes: `Allocated for group mission`,
              timestamp: serverTimestamp(),
            });

            alert("Group mission added successfully.");
            e.target.reset();
            loadGroupMissions();
          } catch (error) {
            console.error("Error adding group mission:", error);
            alert("Failed to add group mission. Please try again.");
          }
        });

      loadTreeOptions();
      loadGroupMissions();
    </script>
  </body>
</html>
